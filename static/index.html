<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§†é¢‘è‡ªåŠ¨å­—å¹• Â· Whisper æœ¬åœ°ç”Ÿæˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #18181c;
      --border: #2a2a30;
      --text: #e4e4e7;
      --muted: #71717a;
      --accent: #a78bfa;
      --accent-hover: #c4b5fd;
      --success: #34d399;
      --error: #f87171;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "DM Sans", -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    .page {
      max-width: 560px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
    }
    .card h2 {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.35rem;
    }
    select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
    }
    select:focus {
      outline: none;
      border-color: var(--accent);
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .row .field { margin-bottom: 0; }
    .row .field:last-of-type { margin-bottom: 0; }
    .field { margin-bottom: 1rem; }
    .api-config-row .field { margin-bottom: 1rem; }
    .api-config-row .field:last-child { margin-bottom: 0; }
    .field:last-child { margin-bottom: 0; }
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(167, 139, 250, 0.06);
    }
    .upload-zone input { display: none; }
    .upload-zone .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.8;
    }
    .upload-zone .hint {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .file-name {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--accent);
      word-break: break-all;
    }
    .btn {
      width: 100%;
      padding: 0.85rem 1.25rem;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: var(--accent);
      color: #0f0f12;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .mode-hint {
      color: var(--muted);
      font-size: 0.82rem;
      font-weight: 400;
      line-height: 1.4;
      margin-top: 0.45rem;
    }
    .status {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }
    .status.visible { display: block; }
    .status.loading {
      background: rgba(167, 139, 250, 0.12);
      color: var(--accent);
    }
    .status.error {
      background: rgba(248, 113, 113, 0.15);
      color: var(--error);
    }
    .status.success {
      background: rgba(52, 211, 153, 0.12);
      color: var(--success);
    }
    .spinner {
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: -0.15em;
      margin-right: 0.4em;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-bar-wrap {
      margin-top: 0.75rem;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .progress-eta {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .ffmpeg-banner {
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid var(--error);
      border-radius: 10px;
      padding: 0.9rem 1rem;
      margin-bottom: 1.25rem;
      font-size: 0.9rem;
      color: var(--text);
    }
    .ffmpeg-banner.hidden { display: none; }
    .ffmpeg-banner .btn-install {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #0f0f12;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .ffmpeg-banner .btn-install:hover { opacity: 0.9; }
    .ffmpeg-banner .btn-install:disabled { opacity: 0.6; cursor: not-allowed; }
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>è§†é¢‘è‡ªåŠ¨å­—å¹•</h1>
    <p class="subtitle">ä¸Šä¼ è§†é¢‘æˆ–éŸ³é¢‘ï¼Œé€‰æ‹© Whisper æ¨¡å‹ä¸è¯­è¨€ï¼Œæœ¬åœ°ç”Ÿæˆ .srt å­—å¹•æ–‡ä»¶</p>

    <div class="card" style="margin-bottom: 1rem;">
      <label for="workMode" style="margin-bottom: 0.35rem;">æ¨¡å¼</label>
      <select id="workMode">
        <option value="transcribe">è½¬å†™ï¼ˆå¯é€‰ç¿»è¯‘ï¼‰</option>
        <option value="translate_only">ä»…ç¿»è¯‘å­—å¹•</option>
      </select>
      <p class="mode-hint" id="workModeHint">è½¬å†™ï¼šä¸Šä¼ è§†é¢‘æˆ–éŸ³é¢‘ï¼Œé€‰æ‹© Whisper æ¨¡å‹ä¸è¯­è¨€ï¼Œæœ¬åœ°ç”Ÿæˆ .srtï¼›å¯é€‰ç¿»è¯‘æˆå¦ä¸€è¯­è¨€</p>
    </div>

    <div class="ffmpeg-banner hidden" id="ffmpegBanner">
      <span id="ffmpegBannerText"></span>
      <div><button type="button" class="btn-install" id="ffmpegInstallBtn">ä¸€é”®ä¸‹è½½å¹¶å®‰è£… ffmpeg</button></div>
    </div>

    <div class="card">
      <h2>é€‰æ‹©æ–‡ä»¶</h2>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".mp4,.mkv,.avi,.mov,.wmv,.flv,.webm,.m4v,.mp3,.wav,.m4a,.flac,.ogg,.aac,.wma" />
        <div class="icon">ğŸ“</div>
        <div id="uploadZoneLabel">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘/éŸ³é¢‘åˆ°æ­¤å¤„</div>
        <div class="hint" id="uploadZoneHint">æ”¯æŒ MP4ã€MKVã€AVIã€MOVã€WebMã€MP3ã€WAV ç­‰</div>
        <div class="file-name" id="fileName"></div>
      </div>
    </div>

    <div class="card" id="cardRecognize">
      <h2>è¯†åˆ«è®¾ç½®</h2>
      <div class="row">
        <div class="field">
          <label for="engine">è¯†åˆ«å¼•æ“</label>
          <select id="engine">
            <option value="whisper" selected>Whisperï¼ˆåŸç‰ˆï¼‰</option>
            <option value="faster-whisper">faster-whisperï¼ˆæ›´å¿«ï¼‰</option>
            <option value="purfview-xxl">Purfview XXLï¼ˆexeï¼‰</option>
          </select>
        </div>
        <div class="field">
          <label for="model">Whisper æ¨¡å‹</label>
          <select id="model">
            <option value="tiny">tinyï¼ˆæœ€å¿«ï¼‰</option>
            <option value="tiny.en">tiny.en</option>
            <option value="base" selected>base</option>
            <option value="base.en">base.en</option>
            <option value="small">small</option>
            <option value="small.en">small.en</option>
            <option value="medium">medium</option>
            <option value="medium.en">medium.en</option>
            <option value="large-v1">large-v1</option>
            <option value="large-v2">large-v2</option>
            <option value="large-v3">large-v3</option>
            <option value="large">large</option>
            <option value="large-v3-turbo">large-v3-turbo</option>
            <option value="turbo">turbo</option>
          </select>
        </div>
        <div class="field">
          <label for="language">å­—å¹•è¯­è¨€</label>
          <select id="language">
            <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹</option>
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="ko">í•œêµ­ì–´</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
            <option value="es">EspaÃ±ol</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="pt">PortuguÃªs</option>
            <option value="it">Italiano</option>
            <option value="nl">Nederlands</option>
            <option value="pl">Polski</option>
            <option value="tr">TÃ¼rkÃ§e</option>
            <option value="vi">Tiáº¿ng Viá»‡t</option>
            <option value="th">à¹„à¸—à¸¢</option>
            <option value="id">Indonesia</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card" id="cardTranslate">
      <h2>ç¿»è¯‘ï¼ˆå¯é€‰ï¼‰</h2>
      <p class="hint" style="margin-bottom: 0.75rem;" id="translateHint">å°†è¯†åˆ«å‡ºçš„å­—å¹•ç¿»è¯‘æˆå¦ä¸€ç§è¯­è¨€åå†å¯¼å‡º</p>
      <div class="row">
        <div class="field">
          <label for="translationApi">ç¿»è¯‘ API</label>
          <select id="translationApi">
            <option value="none" selected>ä¸ç¿»è¯‘</option>
            <option value="google">Google ç¿»è¯‘</option>
            <option value="deepl">DeepL</option>
            <option value="openai">OpenAI</option>
          </select>
        </div>
        <div class="field">
          <label for="translateTo">ç¿»è¯‘æˆ</label>
          <select id="translateTo">
            <option value="none" selected>â€”</option>
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="ko">í•œêµ­ì–´</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
            <option value="es">EspaÃ±ol</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="pt">PortuguÃªs</option>
            <option value="it">Italiano</option>
            <option value="nl">Nederlands</option>
            <option value="pl">Polski</option>
            <option value="tr">TÃ¼rkÃ§e</option>
            <option value="vi">Tiáº¿ng Viá»‡t</option>
            <option value="th">à¹„à¸—à¸¢</option>
            <option value="id">Indonesia</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
          </select>
        </div>
      </div>
      <div id="apiConfigOpenai" class="api-config-block" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="field">
          <label for="openaiApiKey">OpenAI API Key</label>
          <input type="password" id="openaiApiKey" placeholder="sk-..." autocomplete="off" />
        </div>
        <div class="field">
          <label for="openaiModel">OpenAI ç¿»è¯‘æ¨¡å‹</label>
          <select id="openaiModel">
            <option value="custom">è‡ªå®šä¹‰â€¦</option>
            <option value="gpt-5">gpt-5</option>
            <option value="gpt-4o-mini" selected>gpt-4o-miniï¼ˆæ¨èï¼‰</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-4-turbo">gpt-4-turbo</option>
            <option value="gpt-4">gpt-4</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
          </select>
        </div>
        <div class="field" id="openaiModelCustomWrap" style="display: none;">
          <label for="openaiModelCustom">è‡ªå®šä¹‰æ¨¡å‹å</label>
          <input type="text" id="openaiModelCustom" placeholder="ä¾‹å¦‚ï¼šgpt-5.2 æˆ– gpt-5mini" autocomplete="off" />
        </div>
      </div>
      <div id="apiConfigDeepl" class="api-config-block" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="field">
          <label for="deeplApiKey">DeepL API Key</label>
          <input type="password" id="deeplApiKey" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡" autocomplete="off" />
        </div>
      </div>
      <div id="apiConfigRules" class="api-config-block" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="field">
          <label for="translationRules">ç¿»è¯‘é£æ ¼ä¸è§„åˆ™ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="translationRules" rows="3" placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨æ­£å¼è¯­æ°”ï¼›å“ç‰Œåã€ä¸“æœ‰åè¯ä¿ç•™è‹±æ–‡ï¼›è¯‘æˆç®€ä½“ä¸­æ–‡å£è¯­åŒ–è¡¨è¾¾ã€‚ä»… OpenAI ç¿»è¯‘æ—¶ç”Ÿæ•ˆã€‚" style="width:100%;padding:0.6rem 0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;resize:vertical;font-family:inherit;"></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" id="submitBtn" disabled>ç”Ÿæˆå­—å¹•</button>
        <button type="button" class="btn" id="cancelBtn" disabled>ç»ˆæ­¢ä»»åŠ¡</button>
      </div>
      <div class="status" id="status"></div>
      <div class="progress-bar-wrap" id="progressBarWrap" style="display: none;">
        <div class="progress-bar-fill" id="progressBarFill"></div>
      </div>
      <div class="progress-eta" id="progressEta"></div>
    </div>

    <footer>æœ¬åœ°è¿è¡Œ Â· æ•°æ®ä¸ä¸Šä¼  Â· åŸºäº OpenAI Whisper Â· <span id="appVersion"></span></footer>
  </div>

  <script>
    const APP_VERSION = "1.5";
    document.getElementById("appVersion").textContent = "v" + APP_VERSION;

    const uploadZone = document.getElementById("uploadZone");
    const fileInput = document.getElementById("fileInput");
    const fileName = document.getElementById("fileName");
    const engine = document.getElementById("engine");
    const model = document.getElementById("model");
    const language = document.getElementById("language");
    const translationApi = document.getElementById("translationApi");
    const translateTo = document.getElementById("translateTo");
    const openaiApiKey = document.getElementById("openaiApiKey");
    const openaiModel = document.getElementById("openaiModel");
    const openaiModelCustom = document.getElementById("openaiModelCustom");
    const openaiModelCustomWrap = document.getElementById("openaiModelCustomWrap");
    const deeplApiKey = document.getElementById("deeplApiKey");
    const apiConfigOpenai = document.getElementById("apiConfigOpenai");
    const apiConfigDeepl = document.getElementById("apiConfigDeepl");
    const apiConfigRules = document.getElementById("apiConfigRules");
    const translationRules = document.getElementById("translationRules");
    const submitBtn = document.getElementById("submitBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const statusEl = document.getElementById("status");
    const progressBarWrap = document.getElementById("progressBarWrap");
    const progressBarFill = document.getElementById("progressBarFill");
    const progressEta = document.getElementById("progressEta");
    const ffmpegBanner = document.getElementById("ffmpegBanner");
    const ffmpegBannerText = document.getElementById("ffmpegBannerText");
    const ffmpegInstallBtn = document.getElementById("ffmpegInstallBtn");
    const workMode = document.getElementById("workMode");
    const uploadZoneLabel = document.getElementById("uploadZoneLabel");
    const uploadZoneHint = document.getElementById("uploadZoneHint");
    const cardRecognize = document.getElementById("cardRecognize");
    const translateHint = document.getElementById("translateHint");
    const workModeHint = document.getElementById("workModeHint");

    const STORAGE_KEY = "auto_subbed_api_config";
    const SETTINGS_KEY = "auto_subbed_settings";
    let currentJobId = null;

    function updateModeUI() {
      const onlyTranslate = workMode.value === "translate_only";
      cardRecognize.style.display = onlyTranslate ? "none" : "block";
      if (onlyTranslate) {
        ffmpegBanner.classList.add("hidden");
      } else {
        checkFfmpegAndShowBanner();
      }
      if (onlyTranslate) {
        workModeHint.textContent = "ä»…ç¿»è¯‘ï¼šä¸Šä¼ å·²æœ‰ .srtï¼Œç›´æ¥ç¿»è¯‘æˆç›®æ ‡è¯­è¨€ï¼Œä¸è¿›è¡Œè¯­éŸ³è¯†åˆ«";
        fileInput.accept = ".srt";
        uploadZoneLabel.textContent = "ç‚¹å‡»æˆ–æ‹–æ‹½ .srt å­—å¹•æ–‡ä»¶åˆ°æ­¤å¤„";
        uploadZoneHint.textContent = "ä»…æ”¯æŒ .srt æ ¼å¼";
        cardTranslate.querySelector("h2").textContent = "ç¿»è¯‘";
        translateHint.textContent = "é€‰æ‹©ç¿»è¯‘ API ä¸ç›®æ ‡è¯­è¨€ï¼Œå¯¼å‡ºç¿»è¯‘åçš„ .srt";
        submitBtn.textContent = "ç¿»è¯‘å­—å¹•";
      } else {
        workModeHint.textContent = "è½¬å†™ï¼šä¸Šä¼ è§†é¢‘æˆ–éŸ³é¢‘ï¼Œé€‰æ‹© Whisper æ¨¡å‹ä¸è¯­è¨€ï¼Œæœ¬åœ°ç”Ÿæˆ .srtï¼›å¯é€‰ç¿»è¯‘æˆå¦ä¸€è¯­è¨€";
        fileInput.accept = ".mp4,.mkv,.avi,.mov,.wmv,.flv,.webm,.m4v,.mp3,.wav,.m4a,.flac,.ogg,.aac,.wma";
        uploadZoneLabel.textContent = "ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘/éŸ³é¢‘åˆ°æ­¤å¤„";
        uploadZoneHint.textContent = "æ”¯æŒ MP4ã€MKVã€AVIã€MOVã€WebMã€MP3ã€WAV ç­‰";
        cardTranslate.querySelector("h2").textContent = "ç¿»è¯‘ï¼ˆå¯é€‰ï¼‰";
        translateHint.textContent = "å°†è¯†åˆ«å‡ºçš„å­—å¹•ç¿»è¯‘æˆå¦ä¸€ç§è¯­è¨€åå†å¯¼å‡º";
        submitBtn.textContent = "ç”Ÿæˆå­—å¹•";
      }
      fileInput.files = null;
      fileName.textContent = "";
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
      currentJobId = null;
    }
    async function checkFfmpegAndShowBanner() {
      try {
        const res = await fetch("/api/ffmpeg/status");
        const data = await res.json();
        if (data.available) {
          ffmpegBanner.classList.add("hidden");
          return;
        }
        ffmpegBannerText.textContent = data.error || "æœªæ£€æµ‹åˆ° ffmpegã€‚";
        ffmpegBanner.classList.remove("hidden");
      } catch (_) {
        ffmpegBanner.classList.add("hidden");
      }
    }
    checkFfmpegAndShowBanner();

    ffmpegInstallBtn.addEventListener("click", async () => {
      ffmpegInstallBtn.disabled = true;
      ffmpegBannerText.textContent = "æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… ffmpegï¼Œè¯·ç¨å€™ï¼ˆçº¦ 1ï½2 åˆ†é’Ÿï¼‰â€¦";
      try {
        const res = await fetch("/api/ffmpeg/install", { method: "POST" });
        const data = await res.json();
        if (data.success) {
          ffmpegBanner.classList.add("hidden");
        } else {
          ffmpegBannerText.textContent = data.message || "å®‰è£…å¤±è´¥";
          ffmpegInstallBtn.disabled = false;
        }
      } catch (e) {
        ffmpegBannerText.textContent = "å®‰è£…è¯·æ±‚å¤±è´¥ï¼š" + (e.message || String(e));
        ffmpegInstallBtn.disabled = false;
      }
    });

    cancelBtn.addEventListener("click", async () => {
      if (!currentJobId) return;
      cancelBtn.disabled = true;
      try {
        await fetch(`/api/jobs/${currentJobId}/cancel`, { method: "POST" });
        showStatus("å·²è¯·æ±‚ç»ˆæ­¢ä»»åŠ¡", "success");
      } catch (_) {
        showStatus("ç»ˆæ­¢ä»»åŠ¡è¯·æ±‚å¤±è´¥", "error");
      }
    });

    function loadApiConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.openai_api_key) openaiApiKey.value = data.openai_api_key;
        if (data.openai_model) openaiModel.value = data.openai_model;
        if (data.openai_model_custom) openaiModelCustom.value = data.openai_model_custom;
        if (data.deepl_api_key) deeplApiKey.value = data.deepl_api_key;
        if (data.translation_rules != null) translationRules.value = data.translation_rules;
      } catch (_) {}
    }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.work_mode) workMode.value = data.work_mode;
        if (data.engine) engine.value = data.engine;
        if (data.model) model.value = data.model;
        if (data.language) language.value = data.language;
        if (data.translation_api) translationApi.value = data.translation_api;
        if (data.translate_to) translateTo.value = data.translate_to;
      } catch (_) {}
    }

    function saveSettings() {
      try {
        const data = {
          work_mode: workMode.value,
          engine: engine.value,
          model: model.value,
          language: language.value,
          translation_api: translationApi.value,
          translate_to: translateTo.value,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
      } catch (_) {}
    }

    function saveApiConfig() {
      try {
        const data = {
          openai_api_key: openaiApiKey.value.trim(),
          openai_model: openaiModel.value,
          openai_model_custom: openaiModelCustom.value.trim(),
          deepl_api_key: deeplApiKey.value.trim(),
          translation_rules: translationRules.value,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (_) {}
    }

    function showApiConfigFor(api) {
      apiConfigOpenai.style.display = api === "openai" ? "block" : "none";
      apiConfigDeepl.style.display = api === "deepl" ? "block" : "none";
      apiConfigRules.style.display = api === "openai" ? "block" : "none";
    }

    loadApiConfig();
    loadSettings();
    updateModeUI();
    showApiConfigFor(translationApi.value);
    translationApi.addEventListener("change", () => {
      showApiConfigFor(translationApi.value);
      saveSettings();
    });
    openaiModelCustomWrap.style.display = openaiModel.value === "custom" ? "block" : "none";
    openaiModel.addEventListener("change", () => {
      openaiModelCustomWrap.style.display = openaiModel.value === "custom" ? "block" : "none";
      saveApiConfig();
    });
    workMode.addEventListener("change", () => {
      updateModeUI();
      saveSettings();
    });
    engine.addEventListener("change", saveSettings);
    model.addEventListener("change", saveSettings);
    language.addEventListener("change", saveSettings);
    translateTo.addEventListener("change", saveSettings);

    openaiApiKey.addEventListener("change", saveApiConfig);
    openaiApiKey.addEventListener("blur", saveApiConfig);
    openaiModelCustom.addEventListener("change", saveApiConfig);
    openaiModelCustom.addEventListener("blur", saveApiConfig);
    deeplApiKey.addEventListener("change", saveApiConfig);
    deeplApiKey.addEventListener("blur", saveApiConfig);
    translationRules.addEventListener("change", saveApiConfig);
    translationRules.addEventListener("blur", saveApiConfig);

    function showStatus(msg, type) {
      statusEl.innerHTML = msg;
      statusEl.className = "status visible " + type;
    }
    function hideStatus() {
      statusEl.className = "status";
      progressBarWrap.style.display = "none";
      progressEta.textContent = "";
    }
    function showProgress(percent, etaSeconds) {
      if (percent == null) {
        progressBarWrap.style.display = "none";
        progressEta.textContent = "";
        return;
      }
      progressBarWrap.style.display = "block";
      progressBarFill.style.width = Math.min(100, Math.max(0, percent)) + "%";
      if (etaSeconds != null && etaSeconds > 0) {
        const m = Math.floor(etaSeconds / 60);
        const s = etaSeconds % 60;
        progressEta.textContent = m ? `çº¦å‰©ä½™ ${m} åˆ† ${s} ç§’` : `çº¦å‰©ä½™ ${etaSeconds} ç§’`;
      } else {
        progressEta.textContent = "";
      }
    }

    uploadZone.addEventListener("click", () => fileInput.click());
    uploadZone.addEventListener("dragover", (e) => { e.preventDefault(); uploadZone.classList.add("dragover"); });
    uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
    uploadZone.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("dragover");
      const f = e.dataTransfer.files[0];
      if (f) setFile(f);
    });
    fileInput.addEventListener("change", () => {
      const f = fileInput.files[0];
      if (f) setFile(f);
    });

    function setFile(file) {
      fileInput.files = null;
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      fileName.textContent = file.name;
      submitBtn.disabled = false;
      hideStatus();
    }

    submitBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      const onlyTranslate = workMode.value === "translate_only";
      if (!file) {
        showStatus(onlyTranslate ? "è¯·å…ˆé€‰æ‹© .srt å­—å¹•æ–‡ä»¶" : "è¯·å…ˆé€‰æ‹©è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶", "error");
        return;
      }
      if (onlyTranslate) {
        if (!file.name.toLowerCase().endsWith(".srt")) {
          showStatus("ä»…ç¿»è¯‘æ¨¡å¼è¯·ä¸Šä¼  .srt æ–‡ä»¶", "error");
          return;
        }
        if (translationApi.value === "none" || translateTo.value === "none") {
          showStatus("è¯·é€‰æ‹©ç¿»è¯‘ API ä¸ç›®æ ‡è¯­è¨€", "error");
          return;
        }
      }
      saveApiConfig();
      submitBtn.disabled = true;
      cancelBtn.disabled = false;
      showStatus('<span class="spinner"></span>ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨è·å–è¿›åº¦â€¦', "loading");
      showProgress(0, null);

      const form = new FormData();
      form.append("file", file);
      form.append("translation_api", translationApi.value);
      form.append("translate_to", translateTo.value);
      if (openaiApiKey.value.trim()) form.append("openai_api_key", openaiApiKey.value.trim());
      if (deeplApiKey.value.trim()) form.append("deepl_api_key", deeplApiKey.value.trim());
      const selectedModel = openaiModel.value === "custom"
        ? (openaiModelCustom.value.trim() || "gpt-4o-mini")
        : openaiModel.value;
      form.append("openai_model", selectedModel);
      if (translationRules.value.trim()) form.append("translation_rules", translationRules.value.trim());

      const apiUrl = onlyTranslate ? "/api/translate" : "/api/transcribe";
      if (!onlyTranslate) {
        form.append("engine", engine.value);
        form.append("model_name", model.value);
        form.append("language", language.value);
      }

      try {
        const startRes = await fetch(apiUrl, { method: "POST", body: form });
        if (!startRes.ok) {
          const err = await startRes.json().catch(() => ({ detail: startRes.statusText }));
          throw new Error(err.detail || startRes.statusText);
        }
        const { job_id } = await startRes.json();
        if (!job_id) throw new Error("ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œæœªè¿”å› job_id");
        currentJobId = job_id;

        let originalDownloaded = false;
        const downloadOne = async (fileParam, defaultName) => {
          const url = fileParam ? `/api/jobs/${job_id}/download?file=${fileParam}` : `/api/jobs/${job_id}/download`;
          const dlRes = await fetch(url);
          if (!dlRes.ok) throw new Error(dlRes.statusText);
          const blob = await dlRes.blob();
          const disp = dlRes.headers.get("Content-Disposition");
          let name = defaultName;
          if (disp) {
            const m = disp.match(/filename="?([^";]+)"?/);
            if (m) name = m[1].trim();
          }
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = name;
          a.click();
          URL.revokeObjectURL(a.href);
        };
        const poll = async () => {
          const jobRes = await fetch(`/api/jobs/${job_id}`);
          if (!jobRes.ok) {
            const err = await jobRes.json().catch(() => ({ detail: jobRes.statusText }));
            throw new Error(err.detail || jobRes.statusText);
          }
          const job = await jobRes.json();
          if (!originalDownloaded && job.filename_original) {
            await downloadOne("original", job.filename_original);
            originalDownloaded = true;
          }
          if (job.status === "error") {
            if (originalDownloaded) {
              showStatus("ç¿»è¯‘å¤±è´¥ï¼Œä½†åŸå­—å¹•å·²ä¸‹è½½", "error");
              cancelBtn.disabled = true;
              submitBtn.disabled = false;
              return true;
            }
            throw new Error(job.error || "ä»»åŠ¡å¤±è´¥");
          }
          if (job.status === "canceled") {
            showStatus("ä»»åŠ¡å·²å–æ¶ˆ", "success");
            showProgress(0, null);
            cancelBtn.disabled = true;
            submitBtn.disabled = false;
            return true;
          }
          if (job.status === "done") {
            if (job.filename_original) {
              if (!originalDownloaded) {
                await downloadOne("original", job.filename_original);
              }
              await downloadOne("translated", job.filename || file.name.replace(/\.[^.]+$/, "") + ".srt");
              showStatus("ä»»åŠ¡å®Œæˆï¼Œå·²ä¸‹è½½ï¼šæœªç¿»è¯‘ + ç¿»è¯‘ç‰ˆ", "success");
            } else {
              await downloadOne(null, file.name.replace(/\.[^.]+$/, "") + ".srt");
              showStatus("ä»»åŠ¡å®Œæˆï¼Œå­—å¹•å·²å¼€å§‹ä¸‹è½½", "success");
            }
            showProgress(100, null);
            submitBtn.disabled = false;
            cancelBtn.disabled = true;
            return true;
          }
          const msg = job.message || "å¤„ç†ä¸­â€¦";
          showStatus(`<span class="spinner"></span>${msg}`, "loading");
          const progressVal = (job.progress === null || job.progress === undefined) ? null : job.progress;
          showProgress(progressVal, job.eta_seconds ?? null);
          return false;
        };

        let done = false;
        while (!done) {
          done = await poll();
          if (!done) await new Promise((r) => setTimeout(r, 1000));
        }
      } catch (e) {
        progressBarWrap.style.display = "none";
        progressEta.textContent = "";
        showStatus("å¤±è´¥ï¼š" + (e.message || String(e)), "error");
      } finally {
        if (submitBtn.disabled) submitBtn.disabled = false;
        cancelBtn.disabled = true;
      }
    });
  </script>
</body>
</html>
